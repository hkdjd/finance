# Transaction Processing Service

基于 Spring Boot 3.x 的交易处理微服务，采用 DDD（领域驱动设计）架构模式。

## 项目特性

- **Spring Boot 3.x** - 最新的 Spring Boot 框架
- **MVC 架构** - 领域驱动设计，清晰的分层架构
- **RESTful API** - 标准的 REST 接口
- **Maven 构建** - 标准的 Maven 项目结构
- **JPA/Hibernate** - 数据持久化
- **单元测试** - 完整的测试覆盖


## 快速开始
注意：当前项目涉及前后端分离，但只做后端部分，前后端通过Rest接口交互！
上传合同后，给用户一个check box，选择当前阶段（预提摊销申请阶段、付款阶段）

### 环境要求

- Java 21
- Maven 3.6+
- PostgreSql

### 步骤1 上传合同，调用外部接口解析获得合同内容：
有一个叫‘合同列表’的前段页面可以上传合同附件（通过导入合同按钮），附件保存到项目配置文件的指定目录中，附件上传成功后：
1.1，保存到合同信息表，该表符合建表规范，并有一个字段叫‘合同附件名称’。
1.2，后端调用一个外部接口，将新导入的附件通过该接口上传到外部系统，通过该接口获得：
    1，合同总金额（totalAmount）
    2，合同开始时间（startDate）
    3，合同结束时间（endDate）
    4，税率（taxRate）
    5，乙方公司名称（verdorName）（甲方为本公司，即OCBC）
1.3，将1.2获得的合同信息保存到合同信息表，并返回该条合同信息的response给前端。该合同信息支持前端的编辑，编辑后，保存到数据库。

### 步骤2 根据步骤1产生的合同信息内容，输出支付时间/预提时间表格
预提摊销表：
预提/摊销期间    入账期间    预提/摊销金额
2025年1月       2025年1月  1000.00
2025年2月       2025年2月  1000.00
2025年3月       2025年3月  1000.00
2025年4月       2025年4月  1000.00
（要求：场景1，当前时间小于合同开始时间，合同总金额自动平均摊销到合同期间的每个月；场景2，如果当前已经在合同开始时间，则合同未开始期间的每个月摊销，分别记录到当前月份；场景3，如果当前时间大于合同结束时间，则不用摊销到每个月，记当前月份的会计分录即可）
支付时间表生成之后，用户可以对该表格的内容进行操作（不支持增删行，只支持修改），然后通过保存按钮保存到数据库。

### 步骤3 产生相应会计分录
前端页面通过合同id请求后端，后端根据步骤2的预提摊销表，生成相应的会计分录列表，先保存到数据库，并返回给前端，前端将会对会计分录进行增删改操作（提供可供查询和修改的接口）。
（场景1，2023年12月审批通过预提待摊申请，摊销期间为2024年1月-2024年3月，摊销总额为3000）
预提摊销表：
预提/摊销期间    入账期间    预提/摊销金额
2025年1月       2025年1月  1000.00
2025年2月       2025年2月  1000.00
2025年3月       2025年3月  1000.00

会计分录：
Booking Date    会计科目    ENTERED DR    ENTERED CR
2024-01-27      费用       1000.00       -
2024-01-27      应付       -             1000
2024-02-27      费用       1000.00       -
2024-02-27      应付       -             1000
2024-03-27      费用       1000.00       -
2024-03-27      应付       -             1000

（场景2，2024年2月审批通过预提待摊申请，摊销期间为2024年1月-2024年3月，摊销总额为3000）
预提摊销表：
预提/摊销期间    入账期间    预提/摊销金额
2025年1月       2025年2月  1000.00
2025年2月       2025年2月  1000.00
2025年3月       2025年3月  1000.00

会计分录：
Booking Date    会计科目    ENTERED DR    ENTERED CR
2024-02-27      费用       1000.00       -
2024-02-27      应付       -             1000
2024-02-27      费用       1000.00       -
2024-02-27      应付       -             1000
2024-03-27      费用       1000.00       -
2024-03-27      应付       -             1000

### 要求步骤2跟步骤3输出形式为List<Entity>形式交给前段，并且后端借支持对数据进行调整（修改，加行或删除行）。步骤1～3分别有一张数据库表来记录相关实体信息，要求有通用的创建时间、修改时间、创建人、修改人等字段，所有表的主键id用自增id。

### 步骤4 付款阶段
将步骤2和步骤3的数据从数据库读取出来，用户在页面填写参数1:付款金额、参数2:付款时间（默认为当天，可修改）后，根据输入参数的情况修改会计分录，以下情形1～情形2中的每个月待摊金额，都来自步骤2中用户确认的每月待摊金额。修改完之后，将会计分录保存到数据库，并返回给前端，会计分录一旦生成不可修改。
（情形1，2024年1月20日，付款获得审批，付款金额1000元，相关付款不涉及预提待摊）
无预提摊销表；
会计分录：
Booking Date    会计科目    ENTERED DR    ENTERED CR
2024-01-20      费用       1000.00       -
2024-01-20      活期存款    -             1000.00

（情形2，订单摊销期间为2024年1月-2024年6月，付款总金额为6000，相关付款涉及预提待摊）
预提摊销表：
预提/摊销期间    入账期间    预提/摊销金额
2024年1月       2024年1月  1000.00
2024年2月       2024年2月  1000.00
2024年3月       2024年3月  1000.00
2024年4月       2024年4月  1000.00
2024年5月       2024年5月  1000.00
2024年6月       2024年6月  1000.00
（情形2.1，用户于3月10号提交付款申请，付款金额2000元，并在预提待摊台账中勾选对应付款期间为1-2月，财务于2024年3月20日完成复核）
会计分录：
Booking Date    会计科目    ENTERED DR    ENTERED CR
2024-03-20      应付       1000.00       -
2024-03-20      应付       1000.00       -
2024-03-20      活期存款    -             2000.00
（情形2.2，用户于3月10号提交付款申请，付款金额2001元，并在预提待摊台账中勾选对应付款期间为1-2月，财务于2024年3月20日完成复核。因为每月待摊金额为1000，所以多出来的1块钱记在借方）
会计分录：
Booking Date    会计科目    ENTERED DR（借方）    ENTERED CR（贷方）
2024-03-20      应付       1000.00               -
2024-03-20      应付       1000.00               -
2024-03-20      费用       1. 00                 -
2024-03-20      活期存款    -                     2001.00
（情形2.3，用户于3月10号提交付款申请，付款金额1999元，并在预提待摊台账中勾选对应付款期间为1-2月，财务于2024年3月20日完成复核）
会计分录：
Booking Date    会计科目    ENTERED DR（借方）    ENTERED CR（贷方）
2024-03-20      应付       1000.00               -
2024-03-20      应付       1000.00               -
2024-03-20      费用       -                     1.00
2024-03-20      活期存款    -                     1999.00
（情形2.4，用户于3月10号提交付款申请，付款金额5999元，并在预提待摊台账中勾选对应付款期间为1-6月，财务于2024年3月20日完成复核）
会计分录：
Booking Date    会计科目    ENTERED DR（借方）    ENTERED CR（贷方）
2024-03-20      应付       1000.00               -
2024-03-20      应付       1000.00               -
2024-03-20      预付       3999.00               -
2024-03-20      活期存款    -                     5999.00
2024-03-27      应付       1000.00               -
2024-03-27      预付       -                     1000.00
2024-04-27      应付       1000.00               -
2024-04-27      预付       -                     1000.00
2024-05-27      应付       1000.00               -
2024-05-27      预付       -                     1000.00
2024-06-27      应付       1000.00               -
2024-06-27      预付       -                     999.00
2024-06-27      费用       -                     1.00
（情形2.5，用户于3月10号提交付款申请，付款金额6001元，并在预提待摊台账中勾选对应付款期间为1-6月，财务于2024年3月20日完成复核）
会计分录：
Booking Date    会计科目    ENTERED DR（借方）    ENTERED CR（贷方）
2024-03-20      应付       1000.00               -
2024-03-20      应付       1000.00               -
2024-03-20      预付       4001.00               -
2024-03-20      活期存款    -                     6001.00
2024-03-27      应付       1000.00               -
2024-03-27      预付       -                     1000.00
2024-04-27      应付       1000.00               -
2024-04-27      预付       -                     1000.00
2024-05-27      应付       1000.00               -
2024-05-27      预付       -                     1000.00
2024-06-27      应付       1000.00               -
2024-06-27      预付       -                     1000.00
2024-06-27      费用       1.00                  -
2024-06-27      预付       -                     1.00
（情形2.6，用户于3月10号提交付款申请，付款金额6000元，并在预提待摊台账中勾选对应付款期间为1-6月，财务于2024年3月20日完成复核）
会计分录：
Booking Date    会计科目    ENTERED DR（借方）    ENTERED CR（贷方）
2024-03-20      应付       1000.00               -
2024-03-20      应付       1000.00               -
2024-03-20      预付       4000.00               -
2024-03-20      活期存款    -                     6000.00
2024-03-27      应付       1000.00               -
2024-03-27      预付       -                     1000.00
2024-04-27      应付       1000.00               -
2024-04-27      预付       -                     1000.00
2024-05-27      应付       1000.00               -
2024-05-27      预付       -                     1000.00
2024-06-27      应付       1000.00               -
2024-06-27      预付       -                     1000.00


## 最后生成接口文档保存到docs/api.md
接口文档格式：
API                        Method           Description          URL
localhost:8081/api/XXX     POST             XXX                  /api/XXX  

## 付款会计分录生成规则
<!-- 借方：应付（对应预提费用）、预付（对应未来期间）、费用（差异调整）
贷方：预付（逐月转预付）、活期存款（实际付款金额）、费用（差异调整） -->
<!-- 总付款金额等于总预提摊销金额，则无费用调整； -->
<!-- 判断是否跨期付款，
非跨期部分，超额支付时无需增加预付借方会计科目，费用调整作为借方费用记录会计分录。不足支付时，费用调整作为贷方费用记录会计分录。
跨期部分，超额支付时先记录借方预付，然后按照选中的摊销期间顺序逐月预付转应付，借方应付仅使用预摊金额，总付款金额大于总预提摊销金额，则剩余金额记入最后一期借方费用，贷方记入最后一期预付，不足支付时则记入最后一期贷方费用。
预付转应付：生成应付后，将预付金额从借方转到贷方。抵扣掉预付金额后，剩余金额记入借方费用。 -->

根据付款时间与摊销入账时间判断是否为过去或未来付款，若为过去付款，则按照对应摊销期间生成借方应付以及活期存款科目，其中应付科目金额为对应摊销期间的预提摊销金额，活期存款科目金额为总付款金额，不足或超额以费用调整；若为未来付款，则按照对应摊销期间生成借方应付以及贷方预付科目，其中应付科目金额为对应摊销期间的预提摊销金额，预付科目金额按照应付科目金额按摊销期间顺序逐月转预付，超额支付增加贷方预付科目以及借方费用科目以平衡借贷，不足金额以贷方费用科目调整。

入账日期变化：
付款日期晚于摊销入账日期，则入账日期均为付款日期；
付款日期早于摊销入账日期，则活期存款以及预付科目的分录的入账日期为付款日期，其余分录入账日期均为该笔摊销的初始入账日期；
前端付款会计科目列表增加一行总计用来实时计算已生成的会计分录是否借贷平衡。


## 自定义文档关键词提取
25行步骤1已经定义了调用外部接口所需要的字段，并且是必填字段，现在需要在调用ai模块（"/api/contract-parse"接口）的接口请求的request中增加用户自定义字段，用户自定义字段通过一个List<String>来表示，ai接口则根据改拓展字段，多返回一个Map<String,String>，key为字段名称，value为字段值。
34行因为有了193行的字段，所以在保存合同时，需要在合同表中增加一个字段，该字段为Map<String,String>类型，用于存储ai接口返回的Map<String,String>。并将这个字段一并返回给前端。
44行中的预提摊销表保留原有的修改功能并提供增加或删除行的功能。

## 自定义文档关键词接口
有一个管理自定义合同提取关键字的功能，每个用户可以管理自己的自定义合同提取关键字。每个用户可以定义多个关键字，生成管理合同提取关键字的接口和表。
合同提取关键字的表，字段为id, user_id, keyword，create_time，update_time，keyword为String类型。

## 解析合同的优化
在上传解析合同的接口中，通过当前用户id，获取用户自定义的合同提取关键字，作为调用ai模块（"/api/contract-parse"接口）的接口请求的request中的用户自定义字段。


## 合同详情页audit log功能
在合同详情页的预提支付表里，如果是已支付的行（状态为已支付在需要，未支付的不用），需要在操作列里增加一个audit log的超链接，点击超链接后，弹窗展示当前行的修改历史（付款操作的操作人id，操作时间，支付金额，付款时间，付款状态等）。
后端有一个audit log的表，记录上述信息，即前端通过该行的id请求后端，后端返回该行的audit log。
